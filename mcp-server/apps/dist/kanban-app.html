<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Kanban Board</title>
  <style>
    :root {
      --bg: #f8fafc;
      --card-bg: #ffffff;
      --text: #1e293b;
      --text-muted: #64748b;
      --border: #e2e8f0;
      --blue-500: #3b82f6;
      --blue-600: #2563eb;
      --green-500: #22c55e;
      --yellow-500: #eab308;
      --red-500: #ef4444;
      --purple-500: #8b5cf6;
      --shadow: 0 1px 3px rgba(0,0,0,0.1);
      --shadow-lg: 0 4px 6px rgba(0,0,0,0.1);
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.5;
    }
    #app { padding: 1rem; min-height: 100px; }

    /* Header */
    .board-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 1rem;
      padding-bottom: 0.75rem;
      border-bottom: 1px solid var(--border);
    }
    .board-title { font-size: 1.25rem; font-weight: 600; }
    .board-stats { font-size: 0.875rem; color: var(--text-muted); }

    /* Columns container */
    .columns {
      display: flex;
      gap: 1rem;
      overflow-x: auto;
      padding-bottom: 0.5rem;
    }

    /* Column */
    .column {
      flex: 0 0 260px;
      background: var(--card-bg);
      border-radius: 8px;
      box-shadow: var(--shadow);
      display: flex;
      flex-direction: column;
      max-height: 400px;
    }
    .column-header {
      padding: 0.75rem;
      border-radius: 8px 8px 0 0;
      font-weight: 600;
      font-size: 0.875rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      color: white;
    }
    .column-count {
      background: rgba(255,255,255,0.3);
      padding: 0.125rem 0.5rem;
      border-radius: 9999px;
      font-size: 0.75rem;
    }
    .column-cards {
      flex: 1;
      overflow-y: auto;
      padding: 0.5rem;
      min-height: 60px;
    }
    .column-cards.drag-over {
      background: rgba(59, 130, 246, 0.1);
      border: 2px dashed var(--blue-500);
      border-radius: 4px;
    }

    /* Card */
    .card {
      background: var(--bg);
      border-radius: 6px;
      padding: 0.75rem;
      margin-bottom: 0.5rem;
      cursor: grab;
      box-shadow: var(--shadow);
      transition: transform 0.15s, box-shadow 0.15s;
    }
    .card:hover { box-shadow: var(--shadow-lg); }
    .card.dragging { opacity: 0.5; cursor: grabbing; }
    .card-title { font-weight: 500; font-size: 0.875rem; margin-bottom: 0.25rem; }
    .card-desc {
      font-size: 0.75rem;
      color: var(--text-muted);
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    .card-footer {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-top: 0.5rem;
    }
    .card-priority {
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }
    .priority-high { background: var(--red-500); }
    .priority-medium { background: var(--yellow-500); }
    .priority-low { background: var(--green-500); }
    .card-tags { display: flex; gap: 0.25rem; flex-wrap: wrap; flex: 1; }
    .tag {
      font-size: 0.625rem;
      background: var(--border);
      color: var(--text-muted);
      padding: 0.125rem 0.375rem;
      border-radius: 4px;
    }

    /* Add card button */
    .add-card-btn {
      width: 100%;
      padding: 0.5rem;
      background: transparent;
      border: 1px dashed var(--border);
      border-radius: 6px;
      cursor: pointer;
      color: var(--text-muted);
      font-size: 0.875rem;
      transition: background 0.15s;
    }
    .add-card-btn:hover { background: var(--bg); }

    /* Add card form */
    .add-card-form { padding: 0.5rem; }
    .add-card-form input, .add-card-form textarea {
      width: 100%;
      padding: 0.5rem;
      border: 1px solid var(--border);
      border-radius: 4px;
      font-size: 0.875rem;
      margin-bottom: 0.5rem;
      transition: border-color 0.2s;
    }
    .add-card-form input:focus, .add-card-form textarea:focus { outline: none; border-color: var(--blue-500); }
    .add-card-form textarea { resize: none; height: 60px; }
    .form-actions { display: flex; gap: 0.5rem; }
    .btn {
      padding: 0.5rem 0.75rem;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 500;
      cursor: pointer;
      border: none;
    }
    button { cursor: pointer; border: none; font: inherit; }
    button:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn-primary { background: var(--blue-500); color: white; }
    .btn-primary:hover:not(:disabled) { background: var(--blue-600); }
    .btn-secondary { background: var(--border); color: var(--text); }
    .btn-secondary:hover:not(:disabled) { background: var(--gray-200); }

    /* Modal */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 100;
    }
    .modal-overlay.show { display: flex; }
    .modal {
      background: var(--card-bg);
      border-radius: 8px;
      width: 90%;
      max-width: 400px;
      padding: 1.5rem;
      box-shadow: var(--shadow-lg);
      animation: slide-up 0.3s ease;
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }
    .modal-title { font-size: 1.125rem; font-weight: 600; }
    .modal-close {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: var(--text-muted);
    }
    .modal-field { margin-bottom: 1rem; }
    .modal-field label {
      display: block;
      font-size: 0.75rem;
      font-weight: 500;
      margin-bottom: 0.25rem;
      color: var(--text-muted);
    }
    .modal-field input, .modal-field textarea, .modal-field select {
      width: 100%;
      padding: 0.5rem;
      border: 1px solid var(--border);
      border-radius: 4px;
      font-size: 0.875rem;
      transition: border-color 0.2s;
    }
    .modal-field input:focus, .modal-field textarea:focus, .modal-field select:focus { outline: none; border-color: var(--blue-500); }
    .modal-field textarea { resize: none; height: 80px; }
    .modal-actions { display: flex; gap: 0.5rem; justify-content: flex-end; margin-top: 1rem; }
    .btn-danger { background: var(--red-500); color: white; }
    .btn-danger:hover:not(:disabled) { background: #dc2626; }
    button:focus-visible { outline: 2px solid var(--blue-500); outline-offset: 2px; }
    .btn:focus-visible { box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2); }
    .btn:active:not(:disabled) { transform: scale(0.98); }
    .card:active { transform: scale(0.99); }

    /* Loading state */
    .loading { text-align: center; padding: 2rem; color: var(--text-muted); }
    @keyframes spin { to { transform: rotate(360deg); } }
    @keyframes slide-up { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    .spinner {
      width: 2rem;
      height: 2rem;
      border: 3px solid var(--border);
      border-top-color: var(--blue-500);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 1rem;
    }
  </style>
</head>
<body>
  <div id="app">
    <div class="loading">
      <div style="font-size: 2rem; margin-bottom: 1rem;">üìã</div>
      <div class="spinner"></div>
      <p>Setting up your board...</p>
    </div>
  </div>

  <!-- Edit Card Modal -->
  <div class="modal-overlay" id="modal">
    <div class="modal">
      <div class="modal-header">
        <span class="modal-title">Edit Card</span>
        <button class="modal-close" onclick="closeModal()">&times;</button>
      </div>
      <div class="modal-field">
        <label>Title</label>
        <input type="text" id="modal-title" />
      </div>
      <div class="modal-field">
        <label>Description</label>
        <textarea id="modal-desc"></textarea>
      </div>
      <div class="modal-field">
        <label>Priority</label>
        <select id="modal-priority">
          <option value="low">Low</option>
          <option value="medium">Medium</option>
          <option value="high">High</option>
        </select>
      </div>
      <div class="modal-actions">
        <button class="btn btn-danger" onclick="deleteCurrentCard()">Delete</button>
        <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
        <button class="btn btn-primary" onclick="saveCard()">Save</button>
      </div>
    </div>
  </div>

  <!-- Delete Confirmation Modal -->
  <div class="modal-overlay" id="delete-modal">
    <div class="modal" style="max-width: 300px; text-align: center;">
      <div style="font-size: 2rem; margin-bottom: 0.75rem;">üóëÔ∏è</div>
      <div class="modal-title" style="margin-bottom: 0.5rem;">Delete Card?</div>
      <p style="color: var(--text-muted); font-size: 0.875rem; margin-bottom: 1rem;">This action cannot be undone.</p>
      <div class="modal-actions" style="justify-content: center;">
        <button class="btn btn-secondary" onclick="cancelDelete()">Cancel</button>
        <button class="btn btn-danger" onclick="confirmDelete()">Delete</button>
      </div>
    </div>
  </div>

  <script>
    // State
    let board = null;
    let currentCard = null;
    let draggedCard = null;

    // MCP Apps communication module (same pattern as fitness-app, recipe-app)
    const mcpApp = (() => {
      let requestId = 1;
      const pendingRequests = new Map();

      // Send JSON-RPC request (expects response)
      function sendRequest(method, params) {
        const id = requestId++;
        return new Promise((resolve, reject) => {
          pendingRequests.set(id, { resolve, reject });
          window.parent.postMessage({ jsonrpc: "2.0", id, method, params }, "*");
        });
      }

      // Send JSON-RPC notification (no response expected)
      function sendNotification(method, params) {
        window.parent.postMessage({ jsonrpc: "2.0", method, params }, "*");
      }

      // Handle incoming messages
      window.addEventListener("message", (event) => {
        const data = event.data;
        if (!data || typeof data !== "object") return;

        // Handle response to our request
        if (data.id && pendingRequests.has(data.id)) {
          const { resolve, reject } = pendingRequests.get(data.id);
          pendingRequests.delete(data.id);
          if (data.error) {
            reject(data.error);
          } else {
            resolve(data.result);
          }
          return;
        }

        // Handle notifications from host
        if (data.method) {
          const handler = notificationHandlers[data.method];
          if (handler) handler(data.params);
        }
      });

      // Notification handlers
      const notificationHandlers = {};
      function onNotification(method, handler) {
        notificationHandlers[method] = handler;
      }

      return { sendRequest, sendNotification, onNotification };
    })();

    function reportSize() {
      const app = document.getElementById("app");
      mcpApp.sendNotification("ui/notifications/size-change", {
        width: Math.ceil(app.scrollWidth),
        height: Math.ceil(app.scrollHeight),
      });
    }

    // Render board
    function renderBoard() {
      if (!board) return;
      const totalCards = board.columns.reduce((sum, c) => sum + c.cards.length, 0);

      const html = `
        <div class="board-header">
          <div class="board-title">${board.name}</div>
          <div class="board-stats">${board.columns.length} columns ¬∑ ${totalCards} cards</div>
        </div>
        <div class="columns">
          ${board.columns.map(col => `
            <div class="column" data-column-id="${col.id}">
              <div class="column-header" style="background: ${col.color}">
                <span>${col.name}</span>
                <span class="column-count">${col.cards.length}</span>
              </div>
              <div class="column-cards"
                   ondragover="handleDragOver(event)"
                   ondragleave="handleDragLeave(event)"
                   ondrop="handleDrop(event, '${col.id}')">
                ${col.cards.map(card => `
                  <div class="card"
                       draggable="true"
                       data-card-id="${card.id}"
                       ondragstart="handleDragStart(event, '${card.id}')"
                       ondragend="handleDragEnd(event)"
                       onclick="openCardModal('${card.id}')">
                    <div class="card-title">${card.title}</div>
                    ${card.description ? `<div class="card-desc">${card.description}</div>` : ''}
                    <div class="card-footer">
                      <div class="card-priority priority-${card.priority}"></div>
                      <div class="card-tags">
                        ${card.tags.slice(0, 2).map(t => `<span class="tag">${t}</span>`).join('')}
                      </div>
                    </div>
                  </div>
                `).join('')}
              </div>
              <div class="add-card-form" id="form-${col.id}" style="display: none;">
                <input type="text" placeholder="Card title" id="input-${col.id}" />
                <div class="form-actions">
                  <button class="btn btn-primary" onclick="submitCard('${col.id}')">Add</button>
                  <button class="btn btn-secondary" onclick="hideAddForm('${col.id}')">Cancel</button>
                </div>
              </div>
              <div style="padding: 0.5rem;" id="btn-${col.id}">
                <button class="add-card-btn" onclick="showAddForm('${col.id}')">+ Add card</button>
              </div>
            </div>
          `).join('')}
        </div>
      `;
      document.getElementById("app").innerHTML = html;
      requestAnimationFrame(reportSize);
    }

    // Drag and drop handlers
    function handleDragStart(e, cardId) {
      draggedCard = cardId;
      e.target.classList.add("dragging");
      e.dataTransfer.effectAllowed = "move";
    }

    function handleDragEnd(e) {
      e.target.classList.remove("dragging");
      draggedCard = null;
    }

    function handleDragOver(e) {
      e.preventDefault();
      e.currentTarget.classList.add("drag-over");
    }

    function handleDragLeave(e) {
      e.currentTarget.classList.remove("drag-over");
    }

    async function handleDrop(e, columnId) {
      e.preventDefault();
      e.currentTarget.classList.remove("drag-over");
      if (!draggedCard || !board) return;

      // Call MCP tool to move card
      try {
        const result = await mcpApp.sendRequest("tools/call", {
          name: "move-card",
          arguments: { boardId: board.id, cardId: draggedCard, targetColumnId: columnId },
        });
        if (result?.structuredContent?.board) {
          board = result.structuredContent.board;
          renderBoard();
        }
      } catch (err) {
        console.error("Move card failed:", err);
      }
    }

    // Add card form
    function showAddForm(colId) {
      document.getElementById(`form-${colId}`).style.display = "block";
      document.getElementById(`btn-${colId}`).style.display = "none";
      document.getElementById(`input-${colId}`).focus();
    }

    function hideAddForm(colId) {
      document.getElementById(`form-${colId}`).style.display = "none";
      document.getElementById(`btn-${colId}`).style.display = "block";
      document.getElementById(`input-${colId}`).value = "";
    }

    async function submitCard(colId) {
      const input = document.getElementById(`input-${colId}`);
      const title = input.value.trim();
      if (!title || !board) return;

      try {
        const result = await mcpApp.sendRequest("tools/call", {
          name: "add-card",
          arguments: { boardId: board.id, columnId: colId, title, priority: "medium" },
        });
        if (result?.structuredContent?.board) {
          board = result.structuredContent.board;
          renderBoard();
        }
      } catch (err) {
        console.error("Add card failed:", err);
      }
      hideAddForm(colId);
    }

    // Modal handlers
    function openCardModal(cardId) {
      // Find card in board
      for (const col of board.columns) {
        const card = col.cards.find(c => c.id === cardId);
        if (card) {
          currentCard = card;
          document.getElementById("modal-title").value = card.title;
          document.getElementById("modal-desc").value = card.description || "";
          document.getElementById("modal-priority").value = card.priority;
          document.getElementById("modal").classList.add("show");
          return;
        }
      }
    }

    function closeModal() {
      document.getElementById("modal").classList.remove("show");
      currentCard = null;
    }

    async function saveCard() {
      if (!currentCard || !board) return;

      const title = document.getElementById("modal-title").value.trim();
      const description = document.getElementById("modal-desc").value.trim();
      const priority = document.getElementById("modal-priority").value;

      if (!title) return;

      try {
        const result = await mcpApp.sendRequest("tools/call", {
          name: "update-card",
          arguments: { boardId: board.id, cardId: currentCard.id, updates: { title, description, priority } },
        });
        if (result?.structuredContent?.board) {
          board = result.structuredContent.board;
          renderBoard();
        }
      } catch (err) {
        console.error("Update card failed:", err);
      }
      closeModal();
    }

    function deleteCurrentCard() {
      if (!currentCard || !board) return;
      // Show delete confirmation modal
      document.getElementById("delete-modal").classList.add("show");
    }

    function cancelDelete() {
      document.getElementById("delete-modal").classList.remove("show");
    }

    async function confirmDelete() {
      if (!currentCard || !board) return;
      document.getElementById("delete-modal").classList.remove("show");

      try {
        const result = await mcpApp.sendRequest("tools/call", {
          name: "delete-card",
          arguments: { boardId: board.id, cardId: currentCard.id },
        });
        if (result?.structuredContent?.board) {
          board = result.structuredContent.board;
          renderBoard();
        }
      } catch (err) {
        console.error("Delete card failed:", err);
      }
      closeModal();
    }

    // Initialize
    window.addEventListener("load", async () => {
      mcpApp.onNotification("ui/notifications/tool-result", (params) => {
        const data = params?.structuredContent;
        if (data?.board) {
          board = data.board;
          renderBoard();
        }
      });

      try {
        await mcpApp.sendRequest("ui/initialize", {
          protocolVersion: "2025-06-18",
          appInfo: { name: "Kanban Board", version: "1.0.0" },
          appCapabilities: {},
        });
        mcpApp.sendNotification("ui/notifications/initialized", {});
      } catch (err) {
        console.error("Init failed:", err);
      }

      new ResizeObserver(reportSize).observe(document.getElementById("app"));
    });
  </script>
</body>
</html>
